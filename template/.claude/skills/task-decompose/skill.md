---
name: task-decompose
description: 複数ファイル/ディレクトリにまたがる大規模な変更が必要な時、並列実行で高速化したい時、または /task-decompose と呼ばれた時に使用する。タスクを独立したサブタスクに分解し、worktree + サブエージェントで並列実行する。
---

# タスク分解スキル

## Overview

大規模なタスクを独立したサブタスクに分解し、git worktree + サブエージェントで安全に並列実行するためのフレームワークです。ファイルオーナーシップを厳密に管理し、競合のない並列開発を実現します。

**Announce at start:** "タスク分解スキルを使って、並列実行可能なサブタスクに分解します。"

## 使用方法

```
/task-decompose <実装したい機能やリファクタリングの説明>
/task-decompose "チャット機能を追加"
/task-decompose "認証フローをリファクタリング"
```

## 分解しない方がよいケース

以下に該当する場合は、このスキルを使わず直接実装すること:

- 変更が 1-2 ファイルのみに収まる
- 変更箇所が密結合で分離できない
- 影響範囲が不明確でまず調査が必要（先に Explore エージェントで調査）
- DB マイグレーション単体のタスク

該当する場合はユーザーに「このタスクは分解せず直接実装した方が効率的です」と伝えて終了する。

## ワークフロー

### Step 1: 五つの問い（思考フレームワーク）

タスクを受け取ったら、まずコードベースを Explore エージェントで調査し、以下の5つの問いに回答する。**この段階ではコード変更を行わない。**

#### Q1. 目的分析
> ユーザーが本当に必要としているものは何か？

- ユーザーの要求を自分の言葉で言い換える
- 暗黙の要件（エラーハンドリング、既存機能との整合性）を洗い出す
- スコープ外のものを明示する

#### Q2. タスク分解
> 何が並列化でき、何に依存関係があるか？

- 変更が必要なファイル/ディレクトリを列挙する
- 独立して作業できる単位にグルーピングする
- 依存関係を矢印で図示する（例: `DB スキーマ → API → UI`）

#### Q3. 最適人数
> ワークツリーはいくつ必要か？

- 目安: 2-3 個が典型的
- 1 個なら分解不要 → 直接実装を提案
- 4 個以上ならタスクが大きすぎる → スコープ縮小を提案

#### Q4. 専門性設計
> 各サブタスクに必要な知識・参照すべきスキルは何か？

- サブタスクごとに必要なコンテキスト（関連ファイル、ドキュメント、スキル）を特定

#### Q5. リスク分析
> ファイル競合、依存関係の問題はあるか？

- 共有リソースの競合ポイントを特定
- 統合時のリスクと対策を明示
- テスト戦略（各サブタスク単体 + 統合後）

**五つの問いの回答をユーザーに提示し、確認を取ってから次のステップに進む。** AskUserQuestion で承認を得ること。

### Step 2: ファイルオーナーシップ宣言

各サブタスクが所有するファイル/ディレクトリを表で明示する。

```markdown
| サブタスク | 所有ファイル | 禁止ファイル |
|-----------|-------------|-------------|
| task-a    | db/migrations/, packages/types/ | apps/web/ |
| task-b    | apps/web/api/ | db/, packages/types/ |
| task-c    | apps/web/components/ | db/, apps/web/api/ |
```

**絶対ルール:**
- 2つのサブタスクが同じファイルに書き込んではならない
- 共有リソース（型定義、グローバルスタイル、共通コンポーネント等）の変更は1つのサブタスクに集約する
- 既存ファイルの変更が複数サブタスクから必要な場合は、依存関係として直列化するか、変更を1つのサブタスクにまとめる

### Step 3: TaskCreate でタスク登録

各サブタスクを TaskCreate で登録する。description には以下のコンテキストテンプレートを含める:

```markdown
## ゴール
<このサブタスクが達成すべきこと>

## 所有ファイル
- <このサブタスクが作成・編集するファイルのリスト>

## 禁止ファイル（他サブタスクが所有）
- <絶対に変更してはならないファイルのリスト>

## 参照コンテキスト
- <参照すべき既存ファイル、ドキュメント、スキル>

## 完了基準
- <具体的な完了条件のリスト>
- <テストが通ること、型エラーがないこと等>
```

依存関係がある場合は `addBlockedBy` で設定する。

### Step 4: ワークツリー作成 & サブエージェント起動

1. `/git-worktrees` スキルでワークツリーを作成する
   - **ベースブランチ**: VDD の `release/*` ブランチ内で分解する場合、リリースブランチをベースに指定する
   - ブランチ命名規則: `feature/<機能名>/<サブタスク名>`
   - ワークツリー作成例: `git worktree add .worktrees/chat-db -b feature/chat/db release/chat-feature`

2. Task tool でサブエージェントを起動する
   - `model: "opus"` を常に指定（手戻り防止のため、タスクの複雑さに関わらず常に opus）
   - `subagent_type: "general-purpose"` を使用
   - blockedBy なしのタスクは**並列起動**（単一メッセージで複数の Task tool を呼び出す）
   - blockedBy ありのタスクは依存タスク完了後に起動
   - **権限設定**: `allowed_tools` でYOLOモード相当の権限を付与する（下記参照）

3. サブエージェントへのプロンプトには以下を含める:
   - TaskGet で取得したタスクの description（コンテキストテンプレート）
   - ワークツリーのパス
   - 「完了したら TaskUpdate で status を completed に更新すること」

### サブエージェントの権限設定（YOLO モード）

リリースブランチのワークツリー内で作業するサブエージェントは、承認待ちで止まらないよう広めの権限を付与する。**ワークツリー + ブランチの二重隔離により、main への影響はない。**

#### 付与する allowed_tools

```json
[
  "Bash({{INSTALL_COMMAND}} *)",
  "Bash({{TEST_COMMAND}} *)",
  "Bash(git add *)",
  "Bash(git commit *)",
  "Bash(git diff *)",
  "Bash(git status *)",
  "Bash(git log *)",
  "Bash(git merge *)",
  "Bash(git rebase *)",
  "Read",
  "Write",
  "Edit",
  "Glob",
  "Grep"
]
```

#### 禁止（allowed_tools に含めない）

| 操作 | 理由 |
|------|------|
| `Bash(git push *)` | リモートへの push は親エージェントが統合後に行う |
| `Bash(git checkout *)` | ワークツリーの隔離を破る可能性がある |
| `Bash(rm -rf *)` | 破壊的操作の防止 |

#### 安全性の根拠

1. **ワークツリー隔離**: サブエージェントは専用ワークツリー内でのみ作業する。ファイルシステムレベルで main のワーキングディレクトリと分離されている
2. **ブランチ隔離**: コミット先は `feature/*` ブランチであり、main に直接影響しない
3. **push 禁止**: リモートへの反映は親エージェントが統合・検証後に行う
4. **統合時の検証**: Step 5 で `{{CHECK_COMMAND}}` を実行し、問題があれば検出される

### Step 5: 統合

全サブタスクが完了したら:

1. **リリースブランチ**に各サブタスクブランチをマージする（main ではなく `release/*` ブランチ）
   ```bash
   # リリースブランチのワークツリーに移動
   cd .worktrees/<release-branch>
   git merge feature/<機能名>/<サブタスク名>
   ```
2. 競合が発生した場合は手動で解消する（ファイルオーナーシップが正しければ競合は起きないはず）
3. `{{CHECK_COMMAND}}` で検証する
4. 検証が通ったらサブタスクのワークツリーを削除する
5. リリースブランチから develop への PR を作成する（VDD Phase 3）

## 注意事項

- サブエージェントは CLAUDE.md のルールに従って動作する。特に `{{CHECK_COMMAND}}` の実行を忘れないこと。
- ワークツリー内での作業は、メインのワーキングディレクトリに影響しない。安心して並列作業できる。
- 統合後に問題が見つかった場合は、該当ファイルのオーナーだったサブタスクの文脈を参照して修正する。
- タスクが想定より複雑だった場合は、途中で再分解してもよい。ただしファイルオーナーシップの再宣言を行うこと。
